

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. 创建合约 &mdash; xuperchain-doc  文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/stat.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="4. 发起提案" href="initiate_proposals.html" />
    <link rel="prev" title="2. 多节点部署" href="multi-nodes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> xuperchain-doc
          

          
          </a>

          
            
            
              <div class="version">
                3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">XuperChain介绍:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/brief.html">1. 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/modules.html">2. 模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/datastruct.html">3. 核心数据结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/smart_contracts.html">4. 智能合约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/permission_system.html">5. 权限系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/privacy.html">6. 隐私和保密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/perfomance.html">7. 性能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/summary.html">8. 总结</a></li>
</ul>
<p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">1. XuperChain环境部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html#basic-operation">2. XuperChain基本操作</a></li>
</ul>
<p class="caption"><span class="caption-text">技术设计文档:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/XuperModel.html">1. XuperModel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/XuperBridge.html">2. XuperBridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/xvm.html">3. XVM虚拟机</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/permission_model.html">4. 账号权限控制模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/p2p.html">5. 超级链p2p网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/authentication.html">6. 身份认证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/proposal.html">7. 提案和投票机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/crypto.html">8. 密码学和隐私保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/extension.html">9. 插件机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/consensus.html">10. 超级链共识框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/chained_bft.html">11. Chained-BFT共识公共组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/xpos.html">12. XPoS共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/xpoa.html">13. XPoA共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/single_pow.html">14. Single及PoW共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/regulatory.html">15. 超级链监管机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/multidisk.html">16. 多盘散列</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/group.html">17. 平行链与群组</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_documents/cross_chain.html">18. 超级链跨链技术</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶使用</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="contract_accounts.html">1. 合约账号</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi-nodes.html">2. 多节点部署</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. 创建合约</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">3.1. 编写合约</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wasm">3.2. 部署wasm合约</a></li>
<li class="toctree-l2"><a class="reference internal" href="#native">3.3. 部署native合约</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acl">3.4. 设置合约方法的ACL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="initiate_proposals.html">4. 发起提案</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi-disks.html">5. 配置变更</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel_chain.html">6. 使用平行链与群组</a></li>
<li class="toctree-l1"><a class="reference internal" href="subscribe.html">7. 使用事件订阅功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="readonly_queries.html">8. 只读跨链场景使用文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_chain.html">9. 非事务场景跨链使用文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="construct-XPoA.html">10. 搭建XPoA共识的超级链网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="xchain-performance.html">11. xchain性能测试使用文档</a></li>
</ul>
<p class="caption"><span class="caption-text">开发应用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developing_apps/eleccert.html">1. 电子存证合约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing_apps/erc721.html">2. 数字资产交易</a></li>
</ul>
<p class="caption"><span class="caption-text">开发手册</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development_manuals/XuperCDT.html">1. 智能合约SDK使用说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_manuals/XdevManual.html">2. 智能合约开发详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_manuals/XuperRPC.html">3. XuperChain RPC 接口使用说明</a></li>
</ul>
<p class="caption"><span class="caption-text">超级链测试环境</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../test_network/description.html">1. 超级链测试环境说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../test_network/guides.html">2. 超级链测试环境使用指南</a></li>
</ul>
<p class="caption"><span class="caption-text">其他</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operations_guides.html">1. 操作指导</a></li>
<li class="toctree-l1"><a class="reference internal" href="../video.html">2. 视频教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands_reference.html">3. 指令介绍(API)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQs.html">4. 常见问题解答</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vocabulary.html">5. 词汇表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lessons.html">6. 超级链小课堂</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">xuperchain-doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>3. 创建合约</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced_usage/create_contracts.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>3. 创建合约<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>3.1. 编写合约<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>源码可以参考 xuperchain/core/contractsdk/go/example/math/math.go</p>
<p>主要实现struct中initialize，invoke和query三个方法来实现自己的逻辑</p>
<div class="highlight-go notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">math</span><span class="p">)</span> <span class="nx">Initialize</span><span class="p">(</span><span class="nx">nci</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">math</span><span class="p">)</span> <span class="nx">Invoke</span><span class="p">(</span><span class="nx">nci</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">math</span><span class="p">)</span> <span class="nx">Query</span><span class="p">(</span><span class="nx">nci</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="nx">code</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>每个函数的入口参数均为 code.Context ，具体结构可参考 xuperchain/core/contractsdk/go/code/context.go
接口中定义了如何获取传入方法的参数，如何使用读写功能，以及如何在链上进行交易/区块的查询、转账或调用其他合约</p>
<div class="highlight-go notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Context</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Args</span><span class="p">()</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span>
    <span class="nx">Caller</span><span class="p">()</span> <span class="kt">string</span>
    <span class="nx">Initiator</span><span class="p">()</span> <span class="kt">string</span>
    <span class="nx">AuthRequire</span><span class="p">()</span> <span class="p">[]</span><span class="kt">string</span>

    <span class="nx">PutObject</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nx">GetObject</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">DeleteObject</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nx">NewIterator</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">limit</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="nx">Iterator</span>

    <span class="nx">QueryTx</span><span class="p">(</span><span class="nx">txid</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">TxStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">QueryBlock</span><span class="p">(</span><span class="nx">blockid</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Block</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">Transfer</span><span class="p">(</span><span class="nx">to</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">amount</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nx">Call</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">contract</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>对于C++版本的合约，可以参考代码 contractsdk/cpp/example/counter.cc 原理和Golang合约是一致的</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">除了 Initialize 外的其他函数，是可以自行定义函数名的，可参考contractsdk/go/example/counter/counter.go中的具体实例，在之后调用合约时写明函数名即可</p>
</div>
</div>
<div class="section" id="wasm">
<h2>3.2. 部署wasm合约<a class="headerlink" href="#wasm" title="永久链接至标题">¶</a></h2>
<ol class="arabic">
<li><p class="first">编译合约 - Golang</p>
<blockquote>
<div><p>注意合约编译环境与源码编译环境一致，编译参数如下</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">GOOS</span><span class="o">=</span>js <span class="nv">GOARCH</span><span class="o">=</span>wasm go build XXX.go
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">编译合约 - C++</p>
<blockquote>
<div><p>对于C++合约，已提供编译脚本，位于 contractsdk/cpp/build.sh，需要注意的是，脚本依赖从hub.baidubce.com拉取的docker镜像，请在编译前确认docker相关环境是可用的</p>
</div></blockquote>
</li>
<li><p class="first">部署wasm合约</p>
<blockquote>
<div><p>将编译好的合约二进制文件（以counter为例）放到目录node/data/blockchain/${chain name}/wasm/下，这里我们默认的链名 ${chain name}=xuper</p>
<p>部署合约的操作需要由合约账号完成，部署操作同样需要支付手续费，操作前需要确保合约账号下有足够的余额</p>
<p>示例中我们的环境里创建了一条名为xuper的链，包含一个合约账号 <strong>XC1111111111111111&#64;xuper</strong></p>
<p>账号的acl查询如下：</p>
<div class="figure align-center">
<img alt="查询acl" src="../_images/checkacl.gif" />
</div>
<p>为部署合约，我们需要事先准备一个符合权限的地址列表（示例中将其保存在 data/acl/addrs 文件），这里因为acl里只有一个AK，我们只需在文件中添加一行（如果acl中需要多个AK，那么编辑文件，每行填写一个即可）</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;XC1111111111111111@xuper/dpzuVdosQrF2kmzumhVeFQZa1aYcdgFpN&quot;</span> &gt; data/acl/addrs
</pre></div>
</div>
<p>然后我们按照以下命令来部署wasm合约counter</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli wasm deploy --account XC1111111111111111@xuper --cname counter -m -a <span class="s1">&#39;{&quot;creator&quot;: &quot;someone&quot;}&#39;</span> -A data/acl/addrs -o tx.output --keys data/keys --name xuper -H localhost:37101 counter
</pre></div>
</div>
<p>此命令看起来很长，但是其中很多参数都有默认值，我们先来看一下参数的含义：</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">wasm</span> <span class="pre">deploy</span></code> ：此为部署wasm合约的命令参数，不做过多解释</li>
<li><code class="docutils literal notranslate"><span class="pre">--account</span> <span class="pre">XC1111111111111111&#64;xuper</span></code> ：此为部署wasm合约的账号（只有合约账号才能进行合约的部署）</li>
<li><code class="docutils literal notranslate"><span class="pre">--cname</span> <span class="pre">counter</span></code> ：这里的counter是指部署后在链上的合约名字，可以自行命名（但有规则，长度在4～16字符）</li>
<li><code class="docutils literal notranslate"><span class="pre">-m</span></code> ：意为多重签名的方式，目前版本的xchain部署wasm合约都需要以这种方式</li>
<li><code class="docutils literal notranslate"><span class="pre">-a</span> <span class="pre">'{&quot;creator&quot;:</span> <span class="pre">&quot;someone&quot;}'</span></code> ：此为传入合约的参数，供合约Initialize方法使用（此参数并非必须，只不过此处的counter合约需要传一个”creator”参数，参见contractsdk/cpp/example/counter.cc）</li>
<li><code class="docutils literal notranslate"><span class="pre">-A</span> <span class="pre">data/acl/addrs</span></code> ：此即为需要收集签名的列表，默认路径为data/acl/addrs，如不是则需要显式传入（注意权重要满足acl要求）</li>
<li><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">tx.output</span></code> ：此为输出的tx文件，可不传，默认文件名为tx.out</li>
<li><code class="docutils literal notranslate"><span class="pre">--keys</span> <span class="pre">data/keys</span></code> ：此为部署发起者的密钥地址，可不传，默认值即为data/keys（部署发起者也要进行签名）</li>
<li><code class="docutils literal notranslate"><span class="pre">--name</span> <span class="pre">xuper</span></code> ：此为区块链名称，默认为xuper，如果创建链名称不是xuper则需要显式传入</li>
<li><code class="docutils literal notranslate"><span class="pre">-H</span> <span class="pre">localhost:37101</span></code> ：xchain服务的地址，默认是本机的37101端口，如不是则需要显式传入</li>
<li>最后的counter是合约编译好的文件（编译完成默认是counter.wasm）</li>
</ul>
<p>在此处，我们大部分参数取的是默认值，所以命令参数不必这么多了</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli wasm deploy --account XC1111111111111111@xuper --cname counter -m -a <span class="s1">&#39;{&quot;creator&quot;: &quot;someone&quot;}&#39;</span> counter
</pre></div>
</div>
<p>运行效果如下</p>
<div class="figure align-center">
<img alt="发起wasm合约部署" src="../_images/deploywasm.gif" />
</div>
<p>运行时会提示手续费的数目，使用 –fee 参数传入即可</p>
<p>然后收集所需AK的签名，因为示例中我们只有一个AK（同时也是发起者），所以只需要签名一次</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli multisig sign --tx tx.out --output sign.out --keys data/keys
</pre></div>
</div>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">--output</span></code> <code class="docutils literal notranslate"><span class="pre">--keys</span></code> 参数也有默认值（输出到sign.out文件，密钥位于data/keys），可以不加。运行后我们即可获得此AK的签名</p>
<p>运行效果如下</p>
<div class="figure align-center">
<img alt="对tx签名" src="../_images/signtx.gif" />
</div>
<p>收集完发起者和acl需要的签名后，我们即可发送交易，完成合约部署了</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli multisig send --tx tx.out sign.out sign.out
</pre></div>
</div>
<p>这里 multisig send 为发送多重签名的命令参数， <code class="docutils literal notranslate"><span class="pre">--tx</span></code> 是交易文件，后边的两个参数分别为发起者的签名和acl的签名（acl中有多个AK时，用逗号连接多个签名文件）。运行命令可得到交易上链后的id，我们也可以使用以下命令来查询部署结果</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli account contracts --account XC1111111111111111@xuper
</pre></div>
</div>
<p>会显示此合约账号部署过的所有合约</p>
<p>运行效果如下</p>
<div class="figure align-center">
<img alt="发送部署交易" src="../_images/sendtx.gif" />
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="native">
<h2>3.3. 部署native合约<a class="headerlink" href="#native" title="永久链接至标题">¶</a></h2>
<p>如果本地搭建超级链环境，在部署、调用native合约之前，请先查看`conf/xchain.yaml` 中native一节，确保native合约功能开启。</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># 管理native合约的配置</span>
<span class="nt">native</span><span class="p">:</span>
    <span class="nt">enable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

    <span class="c1"># docker相关配置</span>
    <span class="nt">docker</span><span class="p">:</span>
        <span class="l l-Scalar l-Scalar-Plain">enable:false</span>
        <span class="l l-Scalar l-Scalar-Plain"># 合约运行的镜像名字</span>
        <span class="l l-Scalar l-Scalar-Plain">imageName</span><span class="p p-Indicator">:</span> <span class="s">&quot;docker.io/centos:7.5.1804&quot;</span>
        <span class="c1"># cpu核数限制，可以为小数</span>
        <span class="nt">cpus</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="c1"># 内存大小限制</span>
        <span class="nt">memory</span><span class="p">:</span> <span class="s">&quot;1G&quot;</span>
    <span class="c1"># 停止合约的等待秒数，超时强制杀死</span>
    <span class="nt">stopTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</td></tr></table></div>
<ol class="arabic">
<li><p class="first">编译合约 - Golang</p>
<blockquote>
<div><p>编译native合约时，只要保持环境和编译XuperChain源码时一致即可，我们还是以contractsdk/go/example中的counter合约为例</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> contractsdk/go/example/counter
go build
<span class="c1"># 产出二进制文件counter，用于合约部署</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">编译合约 - Java</p>
<blockquote>
<div><p>编译Java sdk：Java版本不低于Java1.8版本</p>
<p>包管理器：maven，mvn版本3.6+</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 编译java sdk</span>
<span class="nb">cd</span> contractsdk/java
mvn install -f pom.xml
<span class="c1"># 产出二进制文件target/java-contract-sdk-0.1.0.jar，并自动安装到mvn本地仓库下</span>
</pre></div>
</div>
<p>编译native合约时，我们以contractsdk/java/example中的counter合约为例</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> contractsdk/java/example/counter
mvn package -f pom.xml
<span class="c1"># 产出二进制文件target/counter-0.1.0-jar-with-dependencies.jar，用于合约部署</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">部署合约</p>
<blockquote>
<div><p>部署native合约。针对不同语言实现的合约，主要通过 <code class="docutils literal notranslate"><span class="pre">--runtime</span></code> 字段进行区分</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 部署golang native合约</span>
./xchain-cli native deploy --account XC1111111111111111@xuper -a <span class="s1">&#39;{&quot;creator&quot;:&quot;XC1111111111111111@xuper&quot;}&#39;</span> --fee <span class="m">15587517</span> --runtime go counter --cname golangcounter
<span class="c1"># 部署结果</span>
<span class="c1"># contract response: ok</span>
<span class="c1"># The gas you cousume is: 14311874</span>
<span class="c1"># The fee you pay is: 15587517</span>
<span class="c1"># Tx id: af0d46f6df2edba4d9d9d07e1db457e5267274b1c9fe0611bb994c0aa7931933</span>

<span class="c1"># 部署java native合约</span>
./xchain-cli native deploy --account XC1111111111111111@xuper --fee <span class="m">15587517</span> --runtime java counter-0.1.0-jar-with-dependencies.jar --cname javacounter
<span class="c1"># 部署结果</span>
<span class="c1"># contract response: ok</span>
<span class="c1"># The gas you cousume is: 14311876</span>
<span class="c1"># The fee you pay is: 15587517</span>
<span class="c1"># Tx id: 875d2c9129973a1c64811d7a5a55ca80743102abc30d19f012656fa52ee0f4f7</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">--runtime</span> <span class="pre">go</span></code> ：表示部署的是golang native合约</li>
<li><code class="docutils literal notranslate"><span class="pre">--runtime</span> <span class="pre">java</span></code>：表示部署的是java native合约</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">合约调用</p>
<blockquote>
<div><p>调用native合约。针对不同语言实现的native合约，调用方式相同。通过合约名直接发起合约调用和查询</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 调用golang native合约，Increase方法，golangcounter为合约名</span>
./xchain-cli native invoke --method Increase -a <span class="s1">&#39;{&quot;key&quot;:&quot;test&quot;}&#39;</span> golangcounter --fee <span class="m">10</span>
<span class="c1"># 调用结果</span>
<span class="c1"># contract response: 1</span>
<span class="c1"># The gas you cousume is: 6</span>
<span class="c1"># The fee you pay is: 10</span>
<span class="c1"># Tx id: b387e2247780a5f5da1070a931b37c4fc7f1b68c072768053a43cffe36f2e0fb</span>

<span class="c1"># 调用golang native合约，Get方法，golangcounter为合约名</span>
./xchain-cli native query --method Get -a <span class="s1">&#39;{&quot;key&quot;:&quot;test&quot;}&#39;</span> golangcounter
<span class="c1"># 调用结果</span>
<span class="c1"># contract response: 1</span>

<span class="c1"># 调用java native合约，increase方法，javacounter为合约名</span>
./xchain-cli native invoke --method increase -a <span class="s1">&#39;{&quot;key&quot;:&quot;test&quot;}&#39;</span> javacounter --fee <span class="m">10</span>
<span class="c1"># 调用结果</span>
<span class="c1"># contract response: 1</span>
<span class="c1"># The gas you cousume is: 6</span>
<span class="c1"># The fee you pay is: 10</span>
<span class="c1"># Tx id: 4b46d9b1292481dcac3b504d5f8031e4eff44d8514c9508f121145cfa141d9db</span>

<span class="c1"># 调用java native合约，get方法，javacounter为合约名</span>
./xchain-cli native query --method get -a <span class="s1">&#39;{&quot;key&quot;:&quot;test&quot;}&#39;</span> javacounter
<span class="c1"># 调用结果</span>
<span class="c1"># contract response: 1146398290725d36631aa70f731bc3174e6484a9a</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="acl">
<h2>3.4. 设置合约方法的ACL<a class="headerlink" href="#acl" title="永久链接至标题">¶</a></h2>
<ol class="arabic">
<li><p class="first">准备desc文件setMethodACL.desc</p>
<blockquote>
<div><div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;module_name&quot;</span><span class="p">:</span> <span class="s2">&quot;xkernel&quot;</span><span class="p">,</span>
    <span class="nt">&quot;method_name&quot;</span><span class="p">:</span> <span class="s2">&quot;SetMethodAcl&quot;</span><span class="p">,</span>
    <span class="nt">&quot;args&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;contract_name&quot;</span><span class="p">:</span> <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
        <span class="nt">&quot;method_name&quot;</span><span class="p">:</span> <span class="s2">&quot;increase&quot;</span><span class="p">,</span>
        <span class="nt">&quot;acl&quot;</span><span class="p">:</span> <span class="s2">&quot;{\&quot;pm\&quot;: {\&quot;rule\&quot;: 1,\&quot;acceptValue\&quot;: 1.0},\&quot;aksWeight\&quot;: {\&quot;UU4kyZcQinAMsBSPRLUA34ebXrfZtB4Z8\&quot;: 1}}&quot;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>参数说明：</p>
<ul class="simple">
<li><strong>module_name</strong>： 模块名称，用固定值xkernel</li>
<li><strong>method_name</strong> ：方法名称，用固定值SetMethodAcl</li>
<li><strong>contract_name</strong>：合约名称</li>
<li><strong>method_name</strong>：合约方法名称</li>
<li><strong>acl</strong>：合约方法的acl</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">设置合约方法ACL</p>
<blockquote>
<div><p>设置合约方法ACL的操作，需符合合约账号的ACL，在3.2节，使用 <strong>XC1111111111111111&#64;xuper</strong> 部署的counter合约，合约账号ACL里 只有1个AK，所以在data/acl/addrs中添加1行，如果合约账号ACL里有多个AK，则填写多行。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;XC1111111111111111@xuper/dpzuVdosQrF2kmzumhVeFQZa1aYcdgFpN&quot;</span> &gt; data/acl/addrs
</pre></div>
</div>
<p>执行如下命令，设置ACL：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xchain-cli multisig gen --desc ./setMethodACL.desc --fee <span class="m">1</span> -H <span class="m">127</span>.0.0.1:37101
./xchain-cli multisig sign --output sign.out
./xchain-cli multisig send sign.out sign.out -H <span class="m">127</span>.0.0.1:37101
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">查看合约方法ACL</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>work@<span class="o">]</span>$ deploy-env -&gt; ./xchain-cli acl query --contract counter --method increase -H :37101
<span class="c1"># 执行结果</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;pm&quot;: {</span>
<span class="c1">#     &quot;rule&quot;: 1,</span>
<span class="c1">#     &quot;acceptValue&quot;: 1</span>
<span class="c1">#   },</span>
<span class="c1">#   &quot;aksWeight&quot;: {</span>
<span class="c1">#     &quot;UU4kyZcQinAMsBSPRLUA34ebXrfZtB4Z8&quot;: 1</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="initiate_proposals.html" class="btn btn-neutral float-right" title="4. 发起提案" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="multi-nodes.html" class="btn btn-neutral float-left" title="2. 多节点部署" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, xuper

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>